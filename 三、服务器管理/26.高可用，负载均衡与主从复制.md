

​		数据库服务器可以协同工作，允许第二个服务器接管服务，在第一个服务器宕机的时候(高可用)，或者允许几个计算机用同一份数据提供服务（负载均衡）。理想情况下，数据库服务器可以无缝地协作。以静态网页提供服务的 web 服务器可以十分简单地将 web 请求发送给多个服务器来进行负载均衡。实际上，只读数据库服务器也可以被简单的关联起来。不幸的是，大部分数据库服务器的请求都是读写混合的，读写服务器很难关联到一起。这是因为只读的数据需要被放置在每个服务器上只一次，一个对任何服务器的写需要被每个服务器执行，这样未来的读取请求才能返回一致的结果。

​		这些同步问题对于服务器协同工作是基础的难题。因为没有一个单独的解决方案可以消除所有场景中同步问题的影响，存在多种解决方案。每个解决方案以不同的方法来定位这个问题，最小化特殊负载的影响。

​		一些解决方案通过只允许一个服务器修改数据来处理同步问题。可以修改数据的服务器称为 ***read/write***、***master*** 或 ***primary servers***。跟踪 master 的变化的服务器称为 ***standby*** 或 ***secondary*** 服务器。一个无法连接，只能等到它被 promote 为 master 服务器才能被连接的 standby 服务器称为 ***warm standby*** 服务器，一个接受连接，仅提供只读服务的 standby 服务器叫做 ***hot standby*** 服务器。

​		一些解决方案是同步的，意味着一个数据修改事务不被认为提交，直到所有的服务器提交了这个事务。这保证了，如果发生 master 服务器宕机，不会丢失任何数据，并且所有负载均衡的机器将会返回一致的结果，无论请求的是哪个服务器。与此相反，异步的解决方案允许它的提交和传播到其他服务器之间存在一些延迟，这可能会在切换到备份服务器时丢失一些数据，并且负载均衡的服务器可能返回轻微不同的结果。异步的通信被使用，在同步方案太慢的时候。

​		解决方案也可以根据粒度来分类。一些解决方案可以仅处理一整个数据库服务器，当其他的服务器允许在每个表或每个数据库级别的控制。

​		任何解决方案都要考虑性能。一般在基础功能和性能之间存在一个权衡。例如，一个基础慢的网络的全同步的解决方案可能会比半同步降低性能，而异步的同步方案可能只有一点最小的性能影响。



## 26.1 比较不同的解决方案

##### Shared Disk Failover

​		共享磁盘故障切换通过只有一份数据库避免了同步的开销。它用一个被多个机器共享的磁盘阵列。如果主服务器宕机，后备服务器可能挂载磁盘并启动数据库，就像从数据库 crash 中恢复一样。这允许急速的故障切换，没有数据损失。

​		共享硬件功能在网络存储设备中非常普遍。使用一个网络文件系统也是可能的，虽然必须注意文件系统必须拥有完整的 POSIX 行为(看 [Section 18.2.2.1](https://www.postgresql.org/docs/13/creating-cluster.html#CREATING-CLUSTER-NFS)) 。这个方案的一个明显的限制是如果共享磁盘阵列坏掉或被打断，主服务器和后备服务器都无法正常使用。另一个问题是，后备服务器在主服务器运行的时候不应该访问共享存储。