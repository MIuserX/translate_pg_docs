### 4.1 词法结构
​		词法结构：https://www.postgresql.org/docs/13/sql-syntax-lexical.html



​		SQL输入是一个 **command** 序列。一个 **command** 由一系列 **token** 组成，以 ; 结束。 输入流的终止也是 command 的结束。哪些 token 在一个 command 中是合法的取决于具体的 command 语法。

​		一个 token 可能是个**关键字(keyword)**、**标识符(identifier)**、**quoted identifier**、**literal(或者 constant)**、特殊的字符符号。token 一般被空白字符分隔(空格、tab、换行)，但是如果没有二义性的话也可以不用空白字符分隔()。

​		例如，下列的SQL是(在句法上)合法的：

```sql
SELECT * FROM MY_TABLE;
UPDATE MY_TABLE SET A = 5;
INSERT INTO MY_TABLE VALUES (3, 'hi there');
```

​		这是一个由3个 SQL command 组成的序列，一个 command 占一行(虽然一个command占一行不是必须的；一行可以写多个command，一个command也可以被分成多行)。

​		另外，注释(comments) 也可以出现在 SQL 中。注释不是 token，它们在效果上等同于空白字符。

​		SQL 语法在关于哪个 token 确定一个 command、哪个是操作数(operands)、哪个是参数(parameters)的问题上是不完全一致的。开头的一些 token 一般是 command 的名字，所以在刚才讨论的那个例子中，我们可以说，一个 "SELECT"，一个 "UPDATE"，和一个 "INSERT"。但对于 UPDATE ，一定需要一个 SET token 出现在指定的位置上，而对于 INSERT，总是需要一个 VALUES token 才算完整。具体的语法细节可以查看 [Part VI](https://www.postgresql.org/docs/13/reference.html)。

​		

#### 4.1.1 标识符和关键字

​		上面例子中诸如 `SELECT`, `UPDATE` 或 `VALUES` 的 token 被称为 **关键字(keywords)**，这是说，这些 token 在 SQL 语言中具有固定的意义。`MY_TABLE`  和  `A`  这俩 token 被称为 **标识符(identifiers)**。标识符表示 表、列 或者其他数据库对象的名字，具体取决于它们被用于哪种 SQL command 中。因此，标识符又是被简单的叫做 "名字(names)" 。keywords 和 identifiers 具有相同的词法结构，所以，在我们不了解它所属的语言的话，我们不知道一个 token 到底是 keyword 还是 identifier 。完整的 SQL keywords 列表可以在 [Appendix C](https://www.postgresql.org/docs/13/sql-keywords-appendix.html) 中找到。

​		SQL keywords 和 identifiers 必须以一个字符(`a-z,A-Z`)或一个下划线开头(`_`)。后续的字符可以是 字母(`a-z,A-Z`)、下划线(`_`)、数字字符(`0-9`) 或者美元标志(`$`)。要注意的是，SQL 标准并不允许 identifiers 中包含 $(***译者注：允许 $ 是 pg 对 SQL 的扩展***)，使用 $ 会降低你的应用程序的兼容性。SQL 标准不会定义一个 包含数字字符或以下划线开头或以下划线结尾的 keyword，所以具有这种形式的 identifier 是安全的，不用担心会这会与未来的 SQL 标准冲突。

​		pg 使用的 identifier 的长度不超过  `NAMEDATALEN-1` 个字节；超过这个长度的 identifier 允许被输入，但会被截断。默认情况下，`NAMEDATALEN` 是 64，所以，identifier 最长是 63 字节。如果这个限制对你造成困扰，你可以在源码文件 `src/include/pg_config_manual.h` 增大 `NAMEDATALEN` 。(***译者注：这需要你重新编译***)。

​		keywords 和 unquoted identifiers(无引号的标识符) 是大小写**<span style="color:red">不</span>**敏感的。因此，下列两个 SQL command 是等价的：

```sql
UPDATE MY_TABLE SET A = 5;

uPDaTE my_TabLE SeT a = 5;
```

​		一个常用的约定是，将 keywords 大写，将 names 小写，例如：

```sql
UPDATE my_table SET a = 5;
```

​		还有一种 identifier：delimited identifier(有界的标识符) 或者说 quoted identifier(有引号的标识符)。它的形式是，由双引号(`"`) 括起来的一个任意的字符序列。一个 delimited identifier 就是一个 identifier，不可能是一个 keyword。所以 `"select"` 可能表示一个表或一个列的名字叫做 "select"，因此，一个无引号的 select 就是一个 keyword，如果被用在本该是个表名或列名的位置上，就会触发一个语法错误。上面的例子可以被重写为如下形式：

```sql
UPDATE "my_table" SET "a" = 5;
```

 		quoted identifiers 可以包含任何字符，`0` code 除外。(如果需要包含一个双引号，将双引号写两遍)。这允许你构造出那种几乎不可能的表名或列名，例如，名字可以包含空格或者 `&` 符号。但也要受 `NAMEDATALEN` 的限制。

​		将一个 identifier 用引号括起来，也令它变地**大小写敏感**，相对地，没有用引号括起来的 identifier 被视为是小写。例如，标识符 `FOO`、`foo` 和 `"foo"` 在 pg 看来是等价的，但是 `Foo` 和 `"FOO"` 与前面3个例子的值是不等价的。(pg 将 unquoted identifiers 视为小写与 SQL 标准是不兼容的，因为 SQL 标准将 unquoted identifiers 视为大写。因此，根据 SQL 标准来讲，`foo` 和 `"FOO"` 是等价的，而不是 `"foo"`。如果你想写出兼容的应用程序，建议你全使用 quoted identifiers 或者全使用 unquoted identifiers)。

​		quoted identifiers 的另一种变体可以包含以码点(code points)表示的 Unicode 转义字符。这种变体以 `U&` 开头(U大写或小写都是可以的)，后面紧跟着双引号(`U&` 和 `"` 之间不能有空格)，例如，`U&"foo"`。(要注意的是，这个语法给操作符 `&` 带来了歧义。可以在操作符 `&` 两边加上空格来避免这种歧义。) 在引号中，Unicode 字符可以用转义形式来表示，转义形式是：一个反斜杠，后面跟着一个4位的16进制数字；或者一个反斜杠，后面跟着一个 `+` 号，再跟着一个6位的16进制数字。例如，identifier `"data"` 可以被写成：

```sql
U&"d\0061t\+000061"
```

​		下面这个例子，将俄罗斯词语 `"slon"`以古斯拉夫字符写出：

```sql
U&"\0441\043B\043E\043D"
```

​		如果你想用其他字符代替 `\` 来作为转义字符，可以在字符串之后用 `UESCAPE` 子句，例如：

```sql
U&"d!0061t!+000061" UESCAPE '!'
```

​		转义字符可以是任何一个除 ***16进制数字字符(`0-9`, `a-f`, `A-F`)、加号字符(`+`)、单引号字符(`'`)、双引号字符(`"`)、空白字符(空格, tab, 换行符)***之外的的任意单字符。注意，`UESCAPE` 后指定的转义字符是用单引号括起来的，而不是双引号。

​		如果想在 identifier 中包含转义字符的字面值，把它写两次。

​		无论是4位的还是6位的转义都可以被用来指定 UTF-16 码对来组成码点超过 U+FFFF 的字符，但对于6位的转义这是不必要的。(替代对不会被直接存储，会被组成一个单码点。)

​		xxx

​		如果服务器的编码不适 UTF-8，Unicode 码点将会被转换为实际的服务器编码；如果无法转换将会报错。



#### 4.1.2 常量

​		在 pg 中有3种隐式输入的常量：字符串、bit strings 和 数字。常量可以被显式的输入，这可以使表达更加精确，也可以使系统处理更加高效。这两种形式都将在下面的子章节中被讨论。



##### 4.1.2.1 字符串常量

​		SQL 中的字符串常量是一个被单引号括起来的任意字符串，例如 `'This is a string'`。要在一个字符串常量中包含单引号，将它写两次即可。例如 `Dianne''s horse`。注意，这不是双引号，和双引号也是不同的。

​		两个被至少包含一个换行符的空白字符分隔开的字符串常量会被连接在一起，被当作一个字符串常量对待。例如：

```sql
SELECT 'foo'
'bar';
```

​		上面的例子等价于：

```sql
SELECT 'foobar';
```

​		但是：

```sql
SELECT 'foo'      'bar';
```

​		是非法的语法。(这个有些奇异的行为是 SQL 标准规定的；pg 遵循了标准。)



##### 4.1.2.2 带有 C 风格的字符串常量

​		pg 也接受带有转义字符的字符串常量，这是 pg 对 SQL 标准的扩展。一个带有转义字符的字符串常量形式为：以 `E` 开头的(大小写都行)，紧接着就是单引号，例如 `E'foo'`。(当要包含转义字符的字符串跨越多个行，仅仅在第一个单引号的前面带 `E`。) 在一个转义字符串里，反斜杠(`\`) 打头，引出一个类 C 风格的 **反斜杠转义序列**，在这种语法里，反斜杠和紧跟着它的若干个字符表示一个特殊字节的值，下表所示：

| 反斜杠转义序列                   | 解释                         |
| -------------------------------- | ---------------------------- |
| `\b`                             | Backspace                    |
| `\f`                             | form feed                    |
| `\n`                             | 换行                         |
| `\r`                             | 回行首                       |
| `\t`                             | Tab                          |
| `\o, \oo, \ooo (o=0-7)`          | 8进制                        |
| `\xh, \xhh (h=0-9,A-F)`          | 16进制                       |
| `\uxxxx, \Uxxxxxxxx (x=0-9,A-F)` | 16或32 位16进制 Unicode 字符 |

​		除上面表中列出的字符，有其他任何字符跟在反斜杠后，都被解释为字面值。因此，要包含一个反斜杠字符，将它写两次。同时，在一个转义字符串里，也可以用 `\'` 来包含一个单引号。

​		确保你写的字节序列，特别是使用了8进制或12进制转义语法的，对于 pg server 的编码是合法的，是你的责任。一个好的习惯是使用 Unicode 转义字符串或者使用 Unicode 转义语法(在 [Section 4.1.2.3](https://www.postgresql.org/docs/13/sql-syntax-lexical.html#SQL-SYNTAX-STRINGS-UESCAPE))；这时 pg server 会对你的输入做一个检查。

>注意：
>
>​		如果配置参数 `standard_conforming_strings` 是关闭状态，pg server 能识别转义字符串和正常字符串中的反斜杠转义语法。然而，pg 9.1 默认是开启的，这意味着反斜杠转义语法仅仅在转义字符串中被识别。这种行为是更具有SQL标准兼容性的，但可能会将依赖于早期 pg 默认行为的应用程序搞砸。一个变通方案是，设置上述参数为关闭，但最好是不要用反斜杠转义。如果你需要使用反斜杠转义来表达一个字符，在字符串常量前面带个 `E`。
>
>​		另外，`escape_string_warning` 和 `backslash_quote` 也能管理字符串常量中的反斜杠的行为。

​		

##### 4.1.2.3 带有 Unicode 转义字符的字符串常量

​		pg 也支持其他类型的用码点(code points)来指定 Unicode 字符的转义语法。一个 Unicode 转义字符串常量以 `U&` 开头(u大小写都可以)，后面紧跟着单引号，`U&` 与 单引号之间不能有任何空白字符，例如 `U&'foo'`。(注意，这种语法给操作符 `&` 带来了二义性。可以在使用操作符 `&` 时在两边加上一些空格来避免。) 在单引号内，可以用 `\` 后跟4位的16进制数字 或 `\+` 后跟6位的16进制数字表示的码点这两种转义形式来表示 Unicode 字符。 例如，`'data'` 可以写为：

```sql
U&'d\0061t\+000061'
```

​		下面这个例子，将俄罗斯词语 `"slon"`以古斯拉夫字符写出：

```sql
U&'\0441\043B\043E\043D'
```

​		如果你想用其他字符代替 `\` 来作为转义字符，可以在字符串之后用 `UESCAPE` 子句，例如：

```sql
U&'d!0061t!+000061' UESCAPE '!'
```

​		转义字符可以是任何一个除 ***16进制数字字符(`0-9`, `a-f`, `A-F`)、加号字符(`+`)、单引号字符(`'`)、双引号字符(`"`)、空白字符(空格, tab, 换行符)***之外的的任意单字符。

​		如果想在 identifier 中包含转义字符的字面值，把它写两次。

​		xxx

​		如果服务器的编码不适 UTF-8，Unicode 码点将会被转换为实际的服务器编码；如果无法转换将会报错。

​		同时，Unicode 转义语法仅当配置 `standard_conforming_strings` 开启的时候才生效。因为这语法会让客户端感到困惑，可能会把这种 SQL 当作是 SQL注入或者有类似问题的危险SQL。如果这个参数没有开启，这种语法会被报错。



##### 4.1.2.4 Dollar-Quoted 字符串常量





##### 4.1.2.5 Bit-String 常量



##### 4.1.2.6 数字常量



##### 4.1.2.7 其他类型的常量





#### 4.1.3 操作符



#### 4.1.4 特殊字符



#### 4.1.5 注释



#### 4.1.6 操作符

​		如果服务器的编码不是 UTF-8，Unicode 码点将会被转换为实际的服务器编码；如果无法转换将会报错。

